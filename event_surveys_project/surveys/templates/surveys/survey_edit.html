{% extends 'base.html' %} {% load crispy_forms_tags %}{% block content %}
<h1>{{ survey.title }}</h1>
<div class="panel">
  <form method="post">
    {% csrf_token %}
    <table>
      {{ question_form|crispy }}
      <div id="select-options-container" style="display: none" class="mb-3">
        <label for="option-input">Add Options:</label>
        <input type="text" id="option-input" class="form-control mb-2" />
        <button type="button" id="add-option-btn" class="btn btn-secondary">
          Add Option
        </button>
        <ul id="options-list" class="list-group mt-2"></ul>
      </div>
    </table>
    <button class="btn btn-primary" type="submit">Create Question</button>
  </form>
</div>
<table class="table">
  <thead>
    <tr>
      <th scope="col">#</th>
      <th scope="col">Question Text</th>
      <th scope="col">Type</th>
      <th scope="col"></th>
    </tr>
  </thead>
  <tbody>
    {% for question in survey_questions %}
    <tr class="question-table-row">
      <th scope="row">{{question.id}}</th>
      <td>{{ question.question_text }}</td>
      <td>{{ question.get_question_type_display }}</td>
      <!-- This is a method generated by the choices in the model. Mental stuff!! -->
      <td>
        <button
          class="btn btn-outline-danger question-delete-button"
          data-questionid="{{question.id}}"
        >
          <i class="fa fa-trash" aria-hidden="true"></i>
        </button>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<!-- More survey panels... -->
{% endblock %} {% block custom_js %}

<script>
  $(document).ready(function () {
    $(".question-delete-button").on("click", function () {
      const button = $(this);
      const question_id = $(this).data("questionid");
      console.log(question_id);
      const url = `{% url 'question_delete' 0 %}`.replace(
        "/0/",
        `/${question_id}/`
      );
      console.log(url);
      $.ajax({
        type: "POST",
        url: url,
        headers: {
          "X-CSRFToken": "{{ csrf_token }}"
        },
        success: function (response) {
          if (response.success) {
            button.closest(".question-table-row").css("display", "none");
            console.log("you deleted it");
          } else {
            alert("Failed to delete question: " + response.error);
          }
        }
      });
    });

    const selectOptionsContainer = $("#select-options-container");
    const questionTypeField = $("#id_question_type");
    const optionInput = $("#option-input");
    const addOptionBtn = $("#add-option-btn");
    const optionsList = $("#options-list");
    const selectOptionsField = $("#id_select_options");

    function updateSelectOptionsVisibility() {
      const selectedType = questionTypeField.val();
      if (selectedType === "MS" || selectedType === "SS") {
        selectOptionsContainer.show();
      } else {
        selectOptionsContainer.hide();
        optionsList.empty();
        selectOptionsField.val("");
      }
    }

    optionInput.change(function () {
      const optionValue = optionInput.val().trim();
      if (optionValue) {
      } else {
        addOptionBtn.prop("disabled", true);
      }
    });

    addOptionBtn.click(function () {
      const optionValue = optionInput.val().trim();
      if (optionValue) {
        const listItem = $("<li></li>")
          .addClass(
            "list-group-item d-flex justify-content-between align-items-center"
          )
          .text(optionValue);

        // Add remove button to list item
        const removeBtn = $("<button></button>")
          .addClass("btn btn-danger btn-sm")
          .text("Remove")
          .click(function () {
            listItem.remove();
            updateSelectOptionsField();
          });

        listItem.append(removeBtn);
        optionsList.append(listItem);
        optionInput.val("");
        updateSelectOptionsField();
      }
    });

    questionTypeField.change(updateSelectOptionsVisibility);

    function updateSelectOptionsField() {
      const options = [];
      optionsList.find("li").each(function () {
        options.push($(this).contents().first().text().trim());
      });
      selectOptionsField.val(JSON.stringify(options));
    }

    // Initial visibility check
    updateSelectOptionsVisibility();
  });
</script>
{% endblock custom_js %}
